version: '3.9'

services:
  haproxy:
    depends_on:
      - iomt_01
    build: 
      context: ./haproxy
    environment:
      - BALANCE=leastconn
    volumes:
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg
    ports:
      - "1883:1883"
    networks:
      - web
      
  iomt_01:
    build:
      context: .
    labels: [orbiter=true]
    environment:
      - JWT_KEY=MTIz
    deploy:
      mode: replicated
      replicas: 3
      labels: [orbiter=true]
      update_config:
        parallelism: 1
        delay: 3s
    networks:
      - web
  
  web-site:
    build:
      context: ./web
    ports:
      - "82:82"
    networks:
      - web

  orbiter:
    image: gianarb/orbiter
    command: /bin/orbiter daemon --debug
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - 8005:8005
    deploy:
      placement:
        constraints:
          - node.role == manager
      mode: replicated
      replicas: 1
    networks:
      - web


     
  

networks:
  web:
    driver: bridge
    